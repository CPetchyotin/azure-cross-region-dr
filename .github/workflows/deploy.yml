name: Deploy Azure DR System

on:
  workflow_dispatch: #à¹ƒà¸«à¹‰à¸à¸”à¸›à¸¸à¹ˆà¸¡à¸£à¸±à¸™à¹€à¸­à¸‡à¹„à¸¡à¹ˆà¸£à¸±à¸™à¸¡à¸±à¹ˆà¸§à¸•à¸­à¸™ Push

permissions:
  contents: read

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_ACCESS_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

jobs:
  # ==========================================
  # ğŸ‡¸ğŸ‡¬ DEPLOY PRIMARY (SINGAPORE)
  # ==========================================
  deploy-sg:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./azure-sg-main
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: echo "${{ secrets.SSH_PUBLIC_KEY }}" > ../id_rsa_azure.pub
      - run: terraform init
      - run: terraform apply -auto-approve

      # ğŸŒŸ 1. à¸”à¸¶à¸‡ IP à¸‚à¸­à¸‡ VM à¸ªà¸´à¸‡à¸„à¹‚à¸›à¸£à¹Œ
      - name: Get SG VM Public IP
        id: get_ip
        run: echo "SG_IP=$(terraform output -raw primary_public_ip)" >> $GITHUB_ENV

      # ğŸŒŸ 2. à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¸£à¸­à¹„à¸§à¹‰
      - name: Create Web Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SG_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: mkdir -p /home/adminuser/my-web

      # ğŸŒŸ 3. à¹‚à¸¢à¸™à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ Next.js à¹„à¸›à¸—à¸µà¹ˆ VM
      - name: Copy Web Files to SG
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SG_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "agss-web/*"
          target: "/home/adminuser/my-web"
          strip_components: 1

      # ğŸŒŸ 4. à¸£à¸±à¸™ Docker Compose Build & Up
      - name: Run Docker Compose on SG
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SG_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/adminuser/my-web

            # ğŸŒŸ 1. à¹€à¸Šà¹‡à¸„à¸à¹ˆà¸­à¸™à¸§à¹ˆà¸²à¸¡à¸µ Docker à¹„à¸«à¸¡ à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¹ƒà¸«à¹‰à¸¥à¸‡à¹à¸šà¸š Official (à¸Šà¸±à¸§à¸£à¹Œà¸ªà¸¸à¸” à¹„à¸¡à¹ˆà¸•à¸´à¸” apt lock)
            if ! command -v docker &> /dev/null || ! docker compose version &> /dev/null; then
                echo "ğŸ³ Docker or Compose V2 not found. Installing official Docker Engine..."
                curl -fsSL https://get.docker.com -o get-docker.sh
                sudo sh get-docker.sh
                sudo usermod -aG docker adminuser
            fi
            
            # ğŸŒŸ 2. à¸šà¸±à¸‡à¸„à¸±à¸š Restart Service à¹ƒà¸«à¹‰à¸ªà¸”à¹ƒà¸«à¸¡à¹ˆà¹€à¸ªà¸¡à¸­ (à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² Daemon à¸«à¸¥à¸±à¸š)
            sudo systemctl daemon-reload
            sudo systemctl restart docker
            
            # ğŸŒŸ 3. à¹€à¸Šà¹‡à¸„à¸ªà¸–à¸²à¸™à¸° à¸–à¹‰à¸²à¸à¸±à¸‡à¹ƒà¸«à¹‰à¸à¹ˆà¸™ Log à¸­à¸­à¸à¸¡à¸²à¸”à¸¹à¹€à¸¥à¸¢
            sudo systemctl status docker --no-pager || sudo journalctl -xe | tail -n 20
            
            # ğŸŒŸ 4. à¸£à¸±à¸™à¹‚à¸›à¸£à¹€à¸ˆà¸„à¸”à¹‰à¸§à¸¢ Compose V2
            sudo docker compose down || true
            sudo docker compose up -d --build
            sleep 10
            sudo docker compose logs web

  # ==========================================
  # ğŸ‡­ğŸ‡° DEPLOY SECONDARY (HONG KONG)
  # ==========================================
  deploy-hk:
    needs: deploy-sg # à¸£à¸­ SG à¹€à¸ªà¸£à¹‡à¸ˆà¸à¹ˆà¸­à¸™
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./azure-hk-secondary
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: echo "${{ secrets.SSH_PUBLIC_KEY }}" > ../id_rsa_azure.pub
      - run: terraform init
      - run: terraform apply -auto-approve

      # ğŸŒŸ 1. à¸”à¸¶à¸‡ IP à¸‚à¸­à¸‡ VM à¸®à¹ˆà¸­à¸‡à¸à¸‡
      - name: Get HK VM Public IP
        id: get_ip
        run: echo "HK_IP=$(terraform output -raw secondary_public_ip)" >> $GITHUB_ENV

      # ğŸŒŸ 2. à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¸£à¸­à¹„à¸§à¹‰
      - name: Create Web Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.HK_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: mkdir -p /home/adminuser/my-web

      # ğŸŒŸ 3. à¹‚à¸¢à¸™à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ Next.js à¹„à¸›à¸—à¸µà¹ˆ VM
      - name: Copy Web Files to HK
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.HK_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "agss-web/*"
          target: "/home/adminuser/my-web"
          strip_components: 1

      # ğŸŒŸ 4. à¸£à¸±à¸™ Docker Compose Build & Up (à¸­à¸±à¸›à¹€à¸à¸£à¸”à¹€à¸›à¹‡à¸™à¸—à¹ˆà¸² Official)
      - name: Run Docker Compose on HK
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.HK_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/adminuser/my-web

            # ğŸŒŸ 1. à¹€à¸Šà¹‡à¸„à¸à¹ˆà¸­à¸™à¸§à¹ˆà¸²à¸¡à¸µ Docker à¹„à¸«à¸¡ à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¹ƒà¸«à¹‰à¸¥à¸‡à¹à¸šà¸š Official (à¸Šà¸±à¸§à¸£à¹Œà¸ªà¸¸à¸” à¹„à¸¡à¹ˆà¸•à¸´à¸” apt lock)
            if ! command -v docker &> /dev/null; then
                echo "ğŸ³ Docker not found. Installing official Docker Engine..."
                curl -fsSL https://get.docker.com -o get-docker.sh
                sudo sh get-docker.sh
                sudo usermod -aG docker adminuser
            fi
            
            # ğŸŒŸ 2. à¸šà¸±à¸‡à¸„à¸±à¸š Restart Service à¹ƒà¸«à¹‰à¸ªà¸”à¹ƒà¸«à¸¡à¹ˆà¹€à¸ªà¸¡à¸­
            sudo systemctl daemon-reload
            sudo systemctl restart docker
            
            # ğŸŒŸ 3. à¹€à¸Šà¹‡à¸„à¸ªà¸–à¸²à¸™à¸° à¸–à¹‰à¸²à¸à¸±à¸‡à¹ƒà¸«à¹‰à¸à¹ˆà¸™ Log à¸­à¸­à¸à¸¡à¸²à¸”à¸¹à¹€à¸¥à¸¢ (Senior Debugging)
            sudo systemctl status docker --no-pager || sudo journalctl -xe | tail -n 20
            
            # ğŸŒŸ 4. à¸£à¸±à¸™à¹‚à¸›à¸£à¹€à¸ˆà¸„à¸”à¹‰à¸§à¸¢ Compose V2
            sudo docker compose down || true
            sudo docker compose up -d --build