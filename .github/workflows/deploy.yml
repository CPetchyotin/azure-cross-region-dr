name: Deploy Azure DR System

on:
  workflow_dispatch: #‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ô‡∏°‡∏±‡πà‡∏ß‡∏ï‡∏≠‡∏ô Push

permissions:
  contents: read

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_ACCESS_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

jobs:
  # ==========================================
  # üá∏üá¨ DEPLOY PRIMARY (SINGAPORE)
  # ==========================================
  deploy-sg:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./azure-sg-main
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: echo "${{ secrets.SSH_PUBLIC_KEY }}" > ../id_rsa_azure.pub
      - run: terraform init
      - run: terraform apply -auto-approve

      # üåü 1. ‡∏î‡∏∂‡∏á IP ‡∏Ç‡∏≠‡∏á VM ‡∏™‡∏¥‡∏á‡∏Ñ‡πÇ‡∏õ‡∏£‡πå
      - name: Get SG VM Public IP
        id: get_ip
        run: echo "SG_IP=$(terraform output -raw primary_public_ip)" >> $GITHUB_ENV

      # üåü 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≠‡πÑ‡∏ß‡πâ
      - name: Create Web Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SG_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: mkdir -p /home/adminuser/my-web

      # üåü 3. ‡πÇ‡∏¢‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Next.js ‡πÑ‡∏õ‡∏ó‡∏µ‡πà VM
      - name: Copy Web Files to SG
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SG_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "agss-web/*"
          target: "/home/adminuser/my-web"
          strip_components: 1

      # üåü 4. ‡∏£‡∏±‡∏ô Docker Compose Build & Up
      - name: Run Docker Compose on SG
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SG_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/adminuser/my-web

            # üåü ‡∏û‡∏£‡∏∞‡πÄ‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å
            wait_for_apt() {
              while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
              while sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do sleep 5; done
            }

            # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Docker ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏•‡∏á
            if ! command -v docker &> /dev/null; then
              export DEBIAN_FRONTEND=noninteractive
              
              wait_for_apt # üåü ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
              
              sudo apt-get update -y
              sudo apt-get install -y docker.io docker-compose-plugin
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -aG docker adminuser
            fi

            # ‡∏£‡∏±‡∏ô Docker Compose (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏µ‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            sudo docker compose down || true
            sudo docker compose up -d --build
            sleep 10 # ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∂‡∏á
            sudo docker compose logs web
  # ==========================================
  # üá≠üá∞ DEPLOY SECONDARY (HONG KONG)
  # ==========================================
  deploy-hk:
    needs: deploy-sg # ‡∏£‡∏≠ SG ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./azure-hk-secondary
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: echo "${{ secrets.SSH_PUBLIC_KEY }}" > ../id_rsa_azure.pub
      - run: terraform init
      - run: terraform apply -auto-approve

      # üåü 1. ‡∏î‡∏∂‡∏á IP ‡∏Ç‡∏≠‡∏á VM ‡∏Æ‡πà‡∏≠‡∏á‡∏Å‡∏á
      - name: Get HK VM Public IP
        id: get_ip
        run: echo "HK_IP=$(terraform output -raw secondary_public_ip)" >> $GITHUB_ENV

      # üåü 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≠‡πÑ‡∏ß‡πâ
      - name: Create Web Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.HK_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: mkdir -p /home/adminuser/my-web

      # üåü 3. ‡πÇ‡∏¢‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Next.js ‡πÑ‡∏õ‡∏ó‡∏µ‡πà VM
      - name: Copy Web Files to HK
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.HK_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "agss-web/*"
          target: "/home/adminuser/my-web"
          strip_components: 1

      # üåü 4. ‡∏£‡∏±‡∏ô Docker Compose Build & Up
      - name: Run Docker Compose on HK
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.HK_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/adminuser/my-web

            # üåü ‡∏û‡∏£‡∏∞‡πÄ‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å
            wait_for_apt() {
              while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
              while sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do sleep 5; done
            }

            # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Docker ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏•‡∏á
            if ! command -v docker &> /dev/null; then
              export DEBIAN_FRONTEND=noninteractive
              
              wait_for_apt # üåü ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
              
              sudo apt-get update -y
              sudo apt-get install -y docker.io docker-compose-plugin
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -aG docker adminuser
            fi

            # ‡∏£‡∏±‡∏ô Docker Compose (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏µ‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            sudo docker compose down || true
            sudo docker compose up -d --build
