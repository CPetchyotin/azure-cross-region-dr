name: Deploy Azure DR System

on:
  workflow_dispatch: # ‡∏Å‡∏î‡∏£‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ GitHub Actions

permissions:
  contents: read

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_ACCESS_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

jobs:
  # ==========================================
  # üá∏üá¨ DEPLOY PRIMARY (SINGAPORE)
  # ==========================================
  deploy-sg:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./azure-sg-main
    steps:
    - uses: actions/checkout@v4
    - uses: hashicorp/setup-terraform@v3
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏∏‡∏ç‡πÅ‡∏à Public Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Terraform ‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á VM
    - run: echo "${{ secrets.SSH_PUBLIC_KEY }}" > ../id_rsa_azure.pub
    
    - run: terraform init
    - run: terraform apply -auto-approve

    # ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Public IP ‡∏à‡∏≤‡∏Å Output ‡∏Ç‡∏≠‡∏á Terraform
    - name: Get SG VM Public IP
      id: get_ip
      run: echo "SG_IP=$(terraform output -raw primary_public_ip)" >> $GITHUB_ENV

    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡πá‡∏ö
    - name: Create Web Directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SG_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: mkdir -p /home/adminuser/my-web

    # ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ Next.js ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
    - name: Copy Web Files to SG
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.SG_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "agss-web/*"
        target: "/home/adminuser/my-web"
        strip_components: 1

    # ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Docker V2 ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô Container (‡πÅ‡∏ö‡∏ö‡∏£‡∏≠ Apt Lock)
    - name: Run Docker Compose on SG
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SG_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/adminuser/my-web
          export DEBIAN_FRONTEND=noninteractive

          # üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏≠ Apt Lock ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡πà‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
          wait_for_apt() {
            echo "Waiting for apt lock..."
            while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
            while sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do sleep 5; done
          }

          wait_for_apt
          sudo apt-get update -y

          # üåü ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Docker Engine ‡πÅ‡∏•‡∏∞ Plugin V2 (‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà)
          if ! command -v docker &> /dev/null; then
            wait_for_apt
            sudo apt-get install -y docker.io docker-compose-plugin
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo groupadd docker || true
            sudo usermod -aG docker adminuser
          fi

          # ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ö‡∏±‡πä‡∏Å‡∏≠‡∏≠‡∏Å
          sudo apt-get remove -y docker-compose || true

          # üåü ‡∏£‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô Docker V2 (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ)
          sudo docker compose up -d --build --remove-orphans

  # ==========================================
  # üá≠üá∞ DEPLOY SECONDARY (HONG KONG)
  # ==========================================
  deploy-hk:
    # üöÄ ‡∏£‡∏±‡∏ô‡∏Ç‡∏ô‡∏≤‡∏ô‡πÑ‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏á‡∏Ñ‡πÇ‡∏õ‡∏£‡πå (Parallel)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./azure-hk-secondary
    steps:
    - uses: actions/checkout@v4
    - uses: hashicorp/setup-terraform@v3
    
    - run: echo "${{ secrets.SSH_PUBLIC_KEY }}" > ../id_rsa_azure.pub
    
    - run: terraform init
    - run: terraform apply -auto-approve

    - name: Get HK VM Public IP
      id: get_ip
      run: echo "HK_IP=$(terraform output -raw secondary_public_ip)" >> $GITHUB_ENV

    - name: Create Web Directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.HK_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: mkdir -p /home/adminuser/my-web

    - name: Copy Web Files to HK
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.HK_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "agss-web/*"
        target: "/home/adminuser/my-web"
        strip_components: 1

    - name: Run Docker Compose on HK
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.HK_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/adminuser/my-web
          export DEBIAN_FRONTEND=noninteractive

          wait_for_apt() {
            echo "Waiting for apt lock..."
            while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
            while sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do sleep 5; done
          }

          wait_for_apt
          sudo apt-get update -y

          if ! command -v docker &> /dev/null; then
            wait_for_apt
            sudo apt-get install -y docker.io docker-compose-plugin
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo groupadd docker || true
            sudo usermod -aG docker adminuser
          fi

          sudo apt-get remove -y docker-compose || true

          # üåü ‡∏£‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô V2 ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
          sudo docker compose up -d --build --remove-orphans