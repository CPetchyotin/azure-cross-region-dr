name: Deploy Azure DR System

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_ACCESS_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

jobs:
  # ==========================================
  # ğŸ‡¸ğŸ‡¬ DEPLOY PRIMARY (SINGAPORE)
  # ==========================================
  deploy-sg:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./azure-sg-main
    steps:
    - uses: actions/checkout@v4
    - uses: hashicorp/setup-terraform@v3
    
    - run: echo "${{ secrets.SSH_PUBLIC_KEY }}" > ../id_rsa_azure.pub
    
    - run: terraform init
    - run: terraform apply -auto-approve

    - name: Get SG VM Public IP
      id: get_ip
      run: echo "SG_IP=$(terraform output -raw primary_public_ip)" >> $GITHUB_ENV

    # ğŸŒŸ 1. à¸¥à¹‰à¸²à¸‡à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¹€à¸à¹ˆà¸²à¸—à¸´à¹‰à¸‡à¹ƒà¸«à¹‰à¹€à¸«à¸µà¹‰à¸¢à¸™ à¸à¹ˆà¸­à¸™à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸«à¸¡à¹ˆ
    - name: Clean and Create Web Directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SG_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          rm -rf /home/adminuser/my-web
          mkdir -p /home/adminuser/my-web

    # ğŸŒŸ 2. à¹à¸à¹‰ Source à¹€à¸›à¹‡à¸™ agss-web (à¹„à¸¡à¹ˆà¸¡à¸µ /*) à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸à¹Šà¸­à¸šà¸›à¸µà¹‰à¹„à¸Ÿà¸¥à¹Œ Config à¸—à¸µà¹ˆà¸‹à¹ˆà¸­à¸™à¸­à¸¢à¸¹à¹ˆà¹„à¸›à¸”à¹‰à¸§à¸¢
    - name: Copy Web Files to SG
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.SG_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "agss-web"
        target: "/home/adminuser/my-web"
        strip_components: 1

    - name: Run Docker Compose on SG
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SG_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/adminuser/my-web
          export DEBIAN_FRONTEND=noninteractive

          wait_for_apt() {
            while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
            while sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do sleep 5; done
          }

          wait_for_apt
          if ! command -v docker &> /dev/null; then
            sudo apt-get update -y
            sudo apt-get install -y docker.io docker-compose-plugin
            sudo systemctl enable docker
          fi

          sudo systemctl restart docker
          sudo docker system prune -a --volumes -f

          # ğŸŒŸ 3. à¹à¸¢à¸à¸„à¸³à¸ªà¸±à¹ˆà¸‡ Build à¸­à¸­à¸à¸¡à¸² à¹à¸¥à¸°à¹ƒà¸ªà¹ˆ --no-cache à¹€à¸à¸·à¹ˆà¸­à¸šà¸±à¸‡à¸„à¸±à¸šà¸­à¹ˆà¸²à¸™à¹„à¸Ÿà¸¥à¹Œà¹ƒà¸«à¸¡à¹ˆ 100%
          sudo docker compose -p agss_dr build --no-cache
          sudo docker compose -p agss_dr up -d

  # ==========================================
  # ğŸ‡­ğŸ‡° DEPLOY SECONDARY (HONG KONG)
  # ==========================================
  deploy-hk:
    needs: deploy-sg
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./azure-hk-secondary
    steps:
    - uses: actions/checkout@v4
    - uses: hashicorp/setup-terraform@v3
    
    - run: echo "${{ secrets.SSH_PUBLIC_KEY }}" > ../id_rsa_azure.pub
    
    - run: terraform init
    - run: terraform apply -auto-approve

    - name: Get HK VM Public IP
      id: get_ip
      run: echo "HK_IP=$(terraform output -raw secondary_public_ip)" >> $GITHUB_ENV

    # ğŸŒŸ à¸—à¸³à¹€à¸«à¸¡à¸·à¸­à¸™à¸ªà¸´à¸‡à¸„à¹‚à¸›à¸£à¹Œ: à¸¥à¹‰à¸²à¸‡à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¹€à¸à¹ˆà¸²à¸—à¸´à¹‰à¸‡
    - name: Clean and Create Web Directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.HK_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          rm -rf /home/adminuser/my-web
          mkdir -p /home/adminuser/my-web

    # ğŸŒŸ à¸”à¸¶à¸‡à¹„à¸Ÿà¸¥à¹Œà¸¡à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” à¸£à¸§à¸¡à¸–à¸¶à¸‡à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸‹à¹ˆà¸­à¸™à¸­à¸¢à¸¹à¹ˆ
    - name: Copy Web Files to HK
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.HK_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "agss-web"
        target: "/home/adminuser/my-web"
        strip_components: 1

    - name: Run Docker Compose on HK
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.HK_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/adminuser/my-web
          export DEBIAN_FRONTEND=noninteractive

          wait_for_apt() {
            while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
            while sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do sleep 5; done
          }

          wait_for_apt
          if ! command -v docker &> /dev/null; then
            sudo apt-get update -y
            sudo apt-get install -y docker.io docker-compose-plugin
            sudo systemctl enable docker
          fi

          sudo systemctl restart docker
          sudo docker system prune -a --volumes -f
          
          # ğŸŒŸ à¸šà¸±à¸‡à¸„à¸±à¸š Build à¹à¸šà¸š No-Cache
          sudo docker compose -p agss_dr build --no-cache
          sudo docker compose -p agss_dr up -d