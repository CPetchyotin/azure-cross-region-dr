name: Deploy Azure DR System (Enterprise Mode)

on:
  workflow_dispatch:
    inputs:
      infra_sg:
        description: "1. üèóÔ∏è [SG] Deploy Infrastructure (Terraform)"
        type: boolean
        default: false
      app_sg:
        description: "2. üê≥ [SG] Deploy Application (Docker & Next.js)"
        type: boolean
        default: true
      infra_hk:
        description: "3. üèóÔ∏è [HK] Deploy Infrastructure (Terraform)"
        type: boolean
        default: false
      app_hk:
        description: "4. üê≥ [HK] Deploy Application (Docker & Next.js)"
        type: boolean
        default: false

permissions:
  contents: read

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_ACCESS_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

jobs:
  # ==========================================
  # üèóÔ∏è 1. INFRASTRUCTURE: SINGAPORE (SG)
  # ==========================================
  deploy-infra-sg:
    if: ${{ inputs.infra_sg }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./azure-sg-main
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: echo "${{ secrets.SSH_PUBLIC_KEY }}" > ../id_rsa_azure.pub
      - run: terraform init
      - run: terraform apply -auto-approve

  # ==========================================
  # üê≥ 2. APPLICATION: SINGAPORE (SG)
  # ==========================================
  deploy-app-sg:
    needs: deploy-infra-sg
    if: ${{ always() && inputs.app_sg && !contains(needs.*.result, 'failure') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # üåü ‡∏î‡∏∂‡∏á IP ‡∏à‡∏≤‡∏Å Terraform ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
      - uses: hashicorp/setup-terraform@v3
      - name: Get SG IP from Terraform
        working-directory: ./azure-sg-main
        run: |
          terraform init
          echo "SG_IP=$(terraform output -raw primary_public_ip)" >> $GITHUB_ENV

      # üåü ‡∏•‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà
      - name: Create and Clean Web Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SG_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mkdir -p /home/adminuser/my-web
            rm -rf /home/adminuser/my-web/*
            rm -rf /home/adminuser/my-web/.* 2>/dev/null || true

      - name: Copy Web Files to SG
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SG_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "agss-web"
          target: "/home/adminuser/my-web"
          strip_components: 1

      - name: Run Docker Compose on SG
        uses: appleboy/ssh-action@v1.0.3
        env:
          GRAFANA_PASSWORD: ${{ secrets.GRAFANA_PASSWORD }}
          COSMOS_CONNECTION_STRING: ${{ secrets.COSMOS_CONNECTION_STRING }}
        with:
          host: ${{ env.SG_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: GRAFANA_PASSWORD,COSMOS_CONNECTION_STRING
          script: |
            cd /home/adminuser/my-web

            echo "GRAFANA_PASSWORD=$GRAFANA_PASSWORD" > .env
            echo "COSMOS_CONNECTION_STRING=$COSMOS_CONNECTION_STRING" >> .env
            wait_for_apt() {
              while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
              while sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do sleep 5; done
            }

            # üåü ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Official ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö Docker ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            if ! command -v docker &> /dev/null; then
              export DEBIAN_FRONTEND=noninteractive
              wait_for_apt
              echo "üê≥ Installing official Docker Engine..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker adminuser
            fi

            sudo systemctl start docker
            sudo systemctl enable docker

            # ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Build ‡πÉ‡∏´‡∏°‡πà
            sudo docker compose down -v || true
            sudo docker system prune -a --volumes -f
            sudo docker compose build --env-file .env build --no-cache
            sudo docker compose up --env-file .env up -d
            sleep 10
            sudo docker compose logs web
  # ==========================================
  # üèóÔ∏è 3. INFRASTRUCTURE: HONG KONG (HK)
  # ==========================================
  deploy-infra-hk:
    if: ${{ inputs.infra_hk }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./azure-hk-secondary
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: echo "${{ secrets.SSH_PUBLIC_KEY }}" > ../id_rsa_azure.pub
      - run: terraform init
      - run: terraform apply -auto-approve

  # ==========================================
  # üê≥ 4. APPLICATION: HONG KONG (HK)
  # ==========================================
  deploy-app-hk:
    needs: deploy-infra-hk
    if: ${{ always() && inputs.app_hk && !contains(needs.*.result, 'failure') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # üåü ‡∏î‡∏∂‡∏á IP ‡∏à‡∏≤‡∏Å Terraform ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
      - uses: hashicorp/setup-terraform@v3
      - name: Get HK IP from Terraform
        working-directory: ./azure-hk-secondary
        run: |
          terraform init
          echo "HK_IP=$(terraform output -raw secondary_public_ip)" >> $GITHUB_ENV

      - name: Create and Clean Web Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.HK_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mkdir -p /home/adminuser/my-web
            rm -rf /home/adminuser/my-web/*
            rm -rf /home/adminuser/my-web/.* 2>/dev/null || true

      - name: Copy Web Files to HK
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.HK_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "agss-web"
          target: "/home/adminuser/my-web"
          strip_components: 1

      - name: Run Docker Compose on HK
        uses: appleboy/ssh-action@v1.0.3
        env:
          GRAFANA_PASSWORD: ${{ secrets.GRAFANA_PASSWORD }}
          COSMOS_CONNECTION_STRING: ${{ secrets.COSMOS_CONNECTION_STRING }}
        with:
          host: ${{ env.HK_IP }}
          username: adminuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: GRAFANA_PASSWORD,COSMOS_CONNECTION_STRING
          script: |
            cd /home/adminuser/my-web

            echo "GRAFANA_PASSWORD=$GRAFANA_PASSWORD" > .env
            echo "COSMOS_CONNECTION_STRING=$COSMOS_CONNECTION_STRING" >> .env
            wait_for_apt() {
              while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
              while sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do sleep 5; done
            }

            # üåü ‡πÉ‡∏ä‡πâ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Official ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö Docker ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ù‡∏±‡πà‡∏á SG
            if ! command -v docker &> /dev/null; then
              export DEBIAN_FRONTEND=noninteractive
              wait_for_apt
              echo "üê≥ Installing official Docker Engine..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker adminuser
            fi

            sudo systemctl start docker
            sudo systemctl enable docker

            # ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Build ‡πÉ‡∏´‡∏°‡πà
            sudo docker compose down -v || true
            sudo docker system prune -a --volumes -f
            sudo docker compose --env-file .env build --no-cache
            sudo docker compose --env-file .env up -d
            sleep 10
            sudo docker compose logs web
