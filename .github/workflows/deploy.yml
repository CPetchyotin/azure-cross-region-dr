name: Deploy Azure DR System

on:
  workflow_dispatch: # à¸à¸”à¸£à¸±à¸™à¹€à¸­à¸‡à¸œà¹ˆà¸²à¸™à¸«à¸™à¹‰à¸² GitHub Actions

permissions:
  contents: read

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_ACCESS_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

jobs:
  # ==========================================
  # ðŸ‡¸ðŸ‡¬ DEPLOY PRIMARY (SINGAPORE)
  # ==========================================
  deploy-sg:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./azure-sg-main
    steps:
    - uses: actions/checkout@v4
    - uses: hashicorp/setup-terraform@v3
    
    # à¸ªà¸£à¹‰à¸²à¸‡à¸à¸¸à¸à¹à¸ˆ Public Key à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰ Terraform à¹ƒà¸Šà¹‰à¸ªà¸£à¹‰à¸²à¸‡ VM
    - run: echo "${{ secrets.SSH_PUBLIC_KEY }}" > ../id_rsa_azure.pub
    
    - run: terraform init
    - run: terraform apply -auto-approve

    # à¸”à¸¶à¸‡à¸„à¹ˆà¸² Public IP à¸ˆà¸²à¸ Output à¸‚à¸­à¸‡ Terraform
    - name: Get SG VM Public IP
      id: get_ip
      run: echo "SG_IP=$(terraform output -raw primary_public_ip)" >> $GITHUB_ENV

    # à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¸ªà¸³à¸«à¸£à¸±à¸šà¸¥à¸‡à¹€à¸§à¹‡à¸š
    - name: Create Web Directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SG_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: mkdir -p /home/adminuser/my-web

    # à¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œà¹‚à¸›à¸£à¹€à¸ˆà¸„ Next.js à¸‚à¹‰à¸²à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡
    - name: Copy Web Files to SG
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.SG_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "agss-web/*"
        target: "/home/adminuser/my-web"
        strip_components: 1

    # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ Docker à¹à¸¥à¸°à¸ªà¸±à¹ˆà¸‡à¸£à¸±à¸™ Container
    - name: Run Docker Compose on SG
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SG_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/adminuser/my-web
          export DEBIAN_FRONTEND=noninteractive

          # ðŸŒŸ 1. à¹€à¸Šà¹‡à¸„à¹à¸¥à¸°à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ Docker Engine (à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ)
          if ! command -v docker &> /dev/null; then
            sudo apt-get update -y
            sudo apt-get install -y docker.io
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -aG docker adminuser
          fi

          # ðŸŒŸ 2. à¹€à¸Šà¹‡à¸„à¹à¸¥à¸°à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ Docker Compose à¹à¸¢à¸à¸•à¹ˆà¸²à¸‡à¸«à¸²à¸ (à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ)
          if ! command -v docker-compose &> /dev/null; then
            sudo apt-get update -y
            sudo apt-get install -y docker-compose
          fi

          # ðŸŒŸ 3. à¸£à¸±à¸™à¸”à¹‰à¸§à¸¢à¸ªà¸´à¸—à¸˜à¸´à¹Œ sudo à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸Šà¸±à¸§à¸£à¹Œà¹€à¸£à¸·à¹ˆà¸­à¸‡ Permission
          sudo docker-compose down || true
          sudo docker-compose up -d --build

  # ==========================================
  # ðŸ‡­ðŸ‡° DEPLOY SECONDARY (HONG KONG)
  # ==========================================
  deploy-hk:
    # ðŸš€ à¸£à¸±à¸™à¸žà¸£à¹‰à¸­à¸¡à¸à¸±à¸šà¸ªà¸´à¸‡à¸„à¹‚à¸›à¸£à¹Œà¸—à¸±à¸™à¸—à¸µ (Parallel)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./azure-hk-secondary
    steps:
    - uses: actions/checkout@v4
    - uses: hashicorp/setup-terraform@v3
    
    - run: echo "${{ secrets.SSH_PUBLIC_KEY }}" > ../id_rsa_azure.pub
    
    - run: terraform init
    - run: terraform apply -auto-approve

    - name: Get HK VM Public IP
      id: get_ip
      run: echo "HK_IP=$(terraform output -raw secondary_public_ip)" >> $GITHUB_ENV

    - name: Create Web Directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.HK_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: mkdir -p /home/adminuser/my-web

    - name: Copy Web Files to HK
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.HK_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "agss-web/*"
        target: "/home/adminuser/my-web"
        strip_components: 1

    - name: Run Docker Compose on HK
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.HK_IP }}
        username: adminuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/adminuser/my-web
          export DEBIAN_FRONTEND=noninteractive

          if ! command -v docker &> /dev/null; then
            sudo apt-get update -y
            sudo apt-get install -y docker.io
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -aG docker adminuser
          fi

          if ! command -v docker-compose &> /dev/null; then
            sudo apt-get update -y
            sudo apt-get install -y docker-compose
          fi

          sudo docker-compose down || true
          sudo docker-compose up -d --build