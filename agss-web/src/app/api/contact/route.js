import { NextResponse } from "next/server";
import { getContainer } from "@/lib/cosmos";
import nodemailer from "nodemailer"; // üåü 1. Import ‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤

export async function POST(request) {
  try {
    // 1. ‡πÅ‡∏Å‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    const body = await request.json();
    const { fullName, email, phone, interests } = body;

    // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡∏£‡∏ö‡πÑ‡∏´‡∏° (Validation)
    if (!fullName || !email) {
      return NextResponse.json({ error: "Missing required fields" }, { status: 400 });
    }

    // 3. ‡∏õ‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏•‡∏á Database (Cosmos DB ‡∏ä‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON)
    const newLead = {
      fullName,
      email,
      phone: phone || "-", // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏Ç‡∏µ‡∏î‡πÑ‡∏ß‡πâ
      interests: interests || [], // Array ‡∏Ç‡∏≠‡∏á Checkbox ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      status: "New", // ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏ó‡∏≥‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
      createdAt: new Date().toISOString(),
    };

    // 4. ‡∏™‡∏±‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Cosmos DB
    const container = await getContainer();
    await container.items.create(newLead);

    // üåü 5. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏∏‡∏£‡∏∏‡∏©‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå (‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö Gmail ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ .env)
    const transporter = nodemailer.createTransport({
      service: 'gmail',
      auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASS,
      },
    });

    // üåü 6. ‡∏£‡πà‡∏≤‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢ (‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ fullName, email, phone ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°)
    const mailOptions = {
      from: process.env.EMAIL_USER,
      to: process.env.EMAIL_USER, // ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏°‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡∏° Sales ‡∏Å‡πá‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ)
      subject: `üö® [New Lead] ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö: ${fullName}`,
      text: `
        ‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ DR Cloud System ‡∏Ñ‡∏£‡∏±‡∏ö! üéâ
        -----------------------------------
        üë§ ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•: ${fullName}
        üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${email}
        üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ${phone || "-"}
        üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à: ${interests && interests.length > 0 ? interests.join(", ") : "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏"}
        ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏°‡∏≤: ${new Date().toLocaleString('th-TH')}
        -----------------------------------
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!
      `
    };

    // üåü 7. ‡∏™‡∏±‡πà‡∏á‡∏£‡πà‡∏≠‡∏ô‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢!
    await transporter.sendMail(mailOptions);

    // 8. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ö‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ß‡πà‡∏≤ "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"
    return NextResponse.json({ success: true, message: "Talk to an expert request received & Email sent!" }, { status: 201 });

  } catch (error) {
    console.error("DB/Email Error:", error);
    return NextResponse.json({ error: "Internal Server Error" }, { status: 500 });
  }
}